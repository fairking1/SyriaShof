<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Syria Shof - Reset Password">
    <title>Reset Password - Syria Shof</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="auth-page" style="display: flex;">
        <div class="auth-container">
            <div class="logo-container">
                <div class="syria-flag">
                    <div class="flag-stripe flag-green"></div>
                    <div class="flag-stripe flag-white"></div>
                    <div class="flag-stripe flag-black"></div>
                    <div class="stars-container">
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                    </div>
                </div>
                <div class="logo-text">Syria Shof</div>
            </div>

            <!-- Reset Password Form -->
            <div class="auth-form" id="resetPasswordForm">
                <div class="verification-icon">🔐</div>
                <h2 class="auth-title" data-ar="تعيين كلمة مرور جديدة" data-en="Set New Password">تعيين كلمة مرور جديدة</h2>
                <p class="verification-text" data-ar="أدخل كلمة المرور الجديدة" data-en="Enter your new password">
                    أدخل كلمة المرور الجديدة
                </p>
                <input type="password" class="auth-input" id="newPassword" placeholder="كلمة المرور الجديدة" data-ar="كلمة المرور الجديدة" data-en="New Password" autocomplete="new-password">
                <input type="password" class="auth-input" id="confirmPassword" placeholder="تأكيد كلمة المرور" data-ar="تأكيد كلمة المرور" data-en="Confirm Password" autocomplete="new-password">
                <button class="auth-btn" id="resetPasswordBtn" data-ar="إعادة تعيين كلمة المرور" data-en="Reset Password">إعادة تعيين كلمة المرور</button>
                <p class="auth-switch">
                    <a href="/" data-ar="العودة إلى تسجيل الدخول" data-en="Back to Login">العودة إلى تسجيل الدخول</a>
                </p>
                <p class="error-msg" id="resetErrorMsg"></p>
                <p class="success-msg" id="resetSuccessMsg" style="display: none;"></p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let currentLang = 'ar';

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const resetToken = urlParams.get('token');

        if (!resetToken) {
            document.getElementById('resetErrorMsg').textContent = 'رابط غير صالح';
            document.getElementById('resetErrorMsg').style.display = 'block';
            document.getElementById('newPassword').disabled = true;
            document.getElementById('confirmPassword').disabled = true;
            document.getElementById('resetPasswordBtn').disabled = true;
        }

        document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMsg = document.getElementById('resetErrorMsg');
            const successMsg = document.getElementById('resetSuccessMsg');

            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            if (!newPassword || !confirmPassword) {
                errorMsg.textContent = currentLang === 'ar' ? 'الرجاء ملء جميع الحقول' : 'Please fill all fields';
                errorMsg.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorMsg.textContent = currentLang === 'ar' ? 'كلمات المرور غير متطابقة' : 'Passwords do not match';
                errorMsg.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorMsg.textContent = currentLang === 'ar' ? 'كلمة المرور يجب أن تكون 6 أحرف على الأقل' : 'Password must be at least 6 characters';
                errorMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('//api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reset-password',
                        token: resetToken,
                        newPassword: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    successMsg.textContent = currentLang === 'ar' ? '✅ تم إعادة تعيين كلمة المرور بنجاح! جاري التوجيه...' : '✅ Password reset successfully! Redirecting...';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    errorMsg.textContent = data.error || (currentLang === 'ar' ? 'خطأ في إعادة تعيين كلمة المرور' : 'Error resetting password');
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                errorMsg.textContent = currentLang === 'ar' ? 'خطأ في الاتصال بالخادم' : 'Server connection error';
                errorMsg.style.display = 'block';
            }
        });

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>

